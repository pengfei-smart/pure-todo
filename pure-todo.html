<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Pure To Do</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f5f5f7;
      --fg: #111111;
      --fg-muted: #666666;
      --accent: #007aff;
      --border: #e0e0e0;
      --card-bg: #ffffff;
      --completed: #9e9e9e;
      --danger: #ff3b30;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #111111;
        --fg: #f5f5f7;
        --fg-muted: #999999;
        --accent: #0a84ff;
        --border: #333333;
        --card-bg: #1c1c1e;
        --completed: #5e5e5e;
        --danger: #ff453a;
      }
    }
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      background: radial-gradient(circle at top left, #e3f2fd 0, var(--bg) 40%, var(--bg) 100%);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    .app {
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      padding: 24px 16px 32px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 18px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.8);
      padding: 18px 16px 14px;
    }
    @media (prefers-color-scheme: dark) {
      .card {
        background: rgba(18, 18, 19, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.06);
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.7);
      }
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
      padding: 0 2px;
    }
    .title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }
    .subtitle {
      font-size: 12px;
      color: var(--fg-muted);
      user-select: none;
      -webkit-user-select: none;
    }
    .list {
      list-style: none;
      margin: 0;
      padding: 4px 0 0;
      max-height: calc(100vh - 260px);
      overflow-y: auto;
    }
    .item {
      display: flex;
      align-items: center;
      padding: 6px 4px 6px 0;
      border-radius: 10px;
      gap: 8px;
      transition: background 0.12s ease-out, transform 0.08s ease-out;
    }
    .item + .item {
      border-top: 1px solid rgba(0,0,0,0.04);
    }
    @media (prefers-color-scheme: dark) {
      .item + .item {
        border-top: 1px solid rgba(255,255,255,0.04);
      }
    }
    .item.dragging {
      opacity: 0.9;
      transform: scale(1.01);
      background: rgba(0, 0, 0, 0.04);
    }
    @media (prefers-color-scheme: dark) {
      .item.dragging {
        background: rgba(255,255,255,0.08);
      }
    }
    .checkbox {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 2px solid var(--border);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.9);
      transition: background 0.12s ease-out, border-color 0.12s ease-out;
    }
    @media (prefers-color-scheme: dark) {
      .checkbox {
        background: rgba(0, 0, 0, 0.4);
      }
    }
    .checkbox-inner {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: transparent;
      transition: background 0.12s ease-out, transform 0.08s ease-out;
    }
    .item.completed .checkbox {
      border-color: var(--accent);
      background: var(--accent);
    }
    .item.completed .checkbox-inner {
      background: #ffffff;
      transform: scale(0.9);
    }
    .text {
      flex: 1;
      font-size: 15px;
      line-height: 1.4;
      cursor: text;
      word-break: break-word;
    }
    .item.completed .text {
      color: var(--completed);
      text-decoration: line-through;
    }
    .handle {
      width: 18px;
      height: 26px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--fg-muted);
      cursor: grab;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
      font-size: 16px;
      padding-right: 2px;
    }
    .handle::before {
      content: "⋮⋮";
      letter-spacing: -1px;
    }
    .delete-btn {
      border: none;
      background: transparent;
      color: var(--fg-muted);
      cursor: pointer;
      padding: 4px;
      margin-left: 2px;
      border-radius: 999px;
      font-size: 14px;
      line-height: 1;
    }
    .delete-btn:hover {
      color: var(--danger);
      background: rgba(255, 59, 48, 0.08);
    }
    @media (prefers-color-scheme: dark) {
      .delete-btn:hover {
        background: rgba(255, 69, 58, 0.16);
      }
    }
    .empty {
      padding: 6px 4px 10px;
      color: var(--fg-muted);
      font-size: 14px;
      user-select: none;
      -webkit-user-select: none;
    }
    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    .input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 8px 14px;
      font-size: 14px;
      outline: none;
      background: rgba(255, 255, 255, 0.96);
      color: var(--fg);
    }
    @media (prefers-color-scheme: dark) {
      .input {
        background: rgba(0, 0, 0, 0.5);
      }
    }
    .btn {
      border-radius: 999px;
      border: none;
      font-size: 14px;
      padding: 8px 14px;
      cursor: pointer;
      white-space: nowrap;
      background: var(--accent);
      color: #ffffff;
    }
    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      padding: 0 2px;
      gap: 8px;
    }
    .meta {
      font-size: 11px;
      text-align: center;
      color: var(--fg-muted);
      margin-top: 4px;
      user-select: none;
      -webkit-user-select: none;
    }
    @media (max-width: 420px) {
      .title { font-size: 20px; }
      .input-row {
        flex-direction: column;
        align-items: stretch;
      }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="card">
      <header class="header">
        <div>
          <div class="title">Pure To Do</div>
          <div class="subtitle">只记录要做的事 · 无时间 · 拖拽排序 · 可删除</div>
        </div>
      </header>

      <ul id="todo-list" class="list"></ul>
      <div id="empty-state" class="empty">
        还没有任务。写下今天最想完成的第一件事。
      </div>

      <form id="add-form" class="input-row" autocomplete="off">
        <input
          id="new-task-input"
          class="input"
          type="text"
          placeholder="写下要做的事，然后回车或点「添加」…"
        />
        <button type="submit" class="btn">添加</button>
      </form>

      <div class="footer-row">
        <div class="subtitle" id="task-stats"></div>
      </div>
    </section>

    <div class="meta">
      <span>云端同步（Bmob） · 纯文本任务 · 拖拽排序 · 删除</span>
    </div>
  </main>

   <script>
    (function () {
      // ========= 1. GitHub 仓库配置（不用写 token） =========
      var GH_OWNER = "pengfei-smart";       // 你的 GitHub 用户名
      var GH_REPO  = "pure-todo";           // 仓库名
      var GH_PATH  = "tasks.json";          // 用来存任务列表的文件名

      // token 只存在本机 localStorage，不写进代码
      var TOKEN_STORAGE_KEY = "pure_todo_github_token";
      var GITHUB_TOKEN = "";

      var LOCAL_BACKUP_KEY = "pure_todo_github_backup_v1";

      // ========= 2. 状态 & DOM =========
      var tasks = [];  // {id, text, completed}
      var currentSha = null; // GitHub 上 tasks.json 的 sha，用于更新

      var listEl  = document.getElementById("todo-list");
      var emptyEl = document.getElementById("empty-state");
      var formEl  = document.getElementById("add-form");
      var inputEl = document.getElementById("new-task-input");
      var statsEl = document.getElementById("task-stats");

      // ========= 3. 工具：本地备份 =========
      function loadFromLocalBackup() {
        try {
          var raw = localStorage.getItem(LOCAL_BACKUP_KEY);
          if (raw) {
            var parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) {
              tasks = parsed;
            }
          }
        } catch (e) {
          tasks = [];
        }
      }

      function saveToLocalBackup() {
        try {
          localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify(tasks));
        } catch (e) {}
      }

      // ========= 4. 工具：处理 GitHub Token =========
      function ensureToken() {
        if (GITHUB_TOKEN) return true;
        try {
          var stored = localStorage.getItem(TOKEN_STORAGE_KEY);
          if (stored && stored.trim()) {
            GITHUB_TOKEN = stored.trim();
            return true;
          }
        } catch (e) {}

        // 第一次没有 token，就弹一个输入框让你粘贴
        var t = window.prompt(
          "第一次使用云同步，请粘贴你在 GitHub 创建的 Personal Access Token：\n\n" +
          "说明：\n" +
          "1. 这个 Token 只会保存在本机浏览器的 localStorage 中，不会上传到任何服务器；\n" +
          "2. 如果不想用云同步，可以直接点取消，只使用本地存储。"
        );
        if (t && t.trim()) {
          GITHUB_TOKEN = t.trim();
          try {
            localStorage.setItem(TOKEN_STORAGE_KEY, GITHUB_TOKEN);
          } catch (e) {}
          return true;
        } else {
          // 用户没提供 token，就只用本地模式
          console.warn("未配置 GitHub Token，将只使用本地存储。");
          return false;
        }
      }

      function githubHeaders() {
        if (!ensureToken()) {
          // 没有 token 的情况，只返回 Accept 头，GitHub 会匿名限流，只能读公共内容，写会失败
          return {
            "Accept": "application/vnd.github.v3+json"
          };
        }
        return {
          "Content-Type": "application/json",
          "Accept": "application/vnd.github.v3+json",
          "Authorization": "Bearer " + GITHUB_TOKEN
        };
      }

      function encodeBase64(str) {
        // 兼容中文
        return btoa(unescape(encodeURIComponent(str)));
      }

      function decodeBase64(str) {
        return decodeURIComponent(escape(atob(str)));
      }

      // ========= 5. GitHub 读写 =========

      // 从 GitHub 读取 tasks.json
      function loadFromGitHub() {
        var url = "https://api.github.com/repos/" + GH_OWNER + "/" + GH_REPO + "/contents/" + GH_PATH;

        if (!ensureToken()) {
          // 没设置 token，直接跳过云端加载
          return Promise.reject(new Error("NO_TOKEN"));
        }

        return fetch(url, { headers: githubHeaders() })
          .then(function (res) {
            if (res.status === 404) {
              // 文件不存在，当作空列表
              currentSha = null;
              tasks = [];
              return null;
            }
            if (!res.ok) {
              return res.json().catch(function () { return {}; }).then(function (body) {
                var err = new Error("HTTP " + res.status);
                err.status = res.status;
                err.body = body;
                throw err;
              });
            }
            return res.json();
          })
          .then(function (data) {
            if (!data) return;
            currentSha = data.sha;
            if (!data.content) return;
            var decoded = decodeBase64(data.content);
            var parsed = JSON.parse(decoded);
            if (parsed && Array.isArray(parsed.list)) {
              tasks = parsed.list;
            } else {
              tasks = [];
            }
          });
      }

      // 把当前 tasks 写回 GitHub
      function saveToGitHub() {
        if (!ensureToken()) {
          console.warn("未配置 GitHub Token，只保存到本地。");
          return;
        }

        var url = "https://api.github.com/repos/" + GH_OWNER + "/" + GH_REPO + "/contents/" + GH_PATH;
        var text = JSON.stringify({ list: tasks }, null, 2);
        var content = encodeBase64(text);

        var body = {
          message: "Update tasks via Pure To Do - " + new Date().toISOString(),
          content: content
        };
        if (currentSha) {
          body.sha = currentSha;
        }

        return fetch(url, {
          method: "PUT",
          headers: githubHeaders(),
          body: JSON.stringify(body)
        })
          .then(function (res) {
            if (!res.ok) {
              return res.json().catch(function () { return {}; }).then(function (body) {
                var err = new Error("HTTP " + res.status);
                err.status = res.status;
                err.body = body;
                throw err;
              });
            }
            return res.json();
          })
          .then(function (data) {
            if (data && data.content && data.content.sha) {
              currentSha = data.content.sha;
            }
          })
          .catch(function (e) {
            console.warn("保存到 GitHub 失败，仅本地保存：", e);
          });
      }

      var saveTimer = null;
      function saveAll() {
        saveToLocalBackup();
        if (saveTimer) clearTimeout(saveTimer);
        // 稍微防抖一下，避免频繁写 GitHub
        saveTimer = setTimeout(function () {
          saveToGitHub();
        }, 800);
      }

      // ========= 6. 渲染 =========
      function render() {
        listEl.innerHTML = "";
        if (tasks.length === 0) {
          emptyEl.style.display = "block";
          statsEl.textContent = "";
          return;
        }
        emptyEl.style.display = "none";

        for (var i = 0; i < tasks.length; i++) {
          (function (task) {
            var li = document.createElement("li");
            li.className = "item" + (task.completed ? " completed" : "");
            li.draggable = true;
            li.dataset.id = task.id;

            var checkbox = document.createElement("div");
            checkbox.className = "checkbox";
            checkbox.innerHTML = '<div class="checkbox-inner"></div>';
            checkbox.addEventListener("click", function () {
              toggle(task.id);
            });

            var text = document.createElement("div");
            text.className = "text";
            text.textContent = task.text;

            var handle = document.createElement("div");
            handle.className = "handle";

            var del = document.createElement("button");
            del.className = "delete-btn";
            del.textContent = "✕";
            del.title = "删除这条任务";
            del.addEventListener("click", function (e) {
              e.stopPropagation();
              var ok = confirm("确定要删除这条任务吗？\n\n" + task.text);
              if (ok) deleteTask(task.id);
            });

            li.appendChild(checkbox);
            li.appendChild(text);
            li.appendChild(handle);
            li.appendChild(del);

            li.addEventListener("dragstart", function (e) {
              e.dataTransfer.effectAllowed = "move";
              e.dataTransfer.setData("text/plain", task.id);
              li.classList.add("dragging");
            });
            li.addEventListener("dragend", function () {
              li.classList.remove("dragging");
            });
            li.addEventListener("dragover", function (e) {
              e.preventDefault();
            });
            li.addEventListener("drop", function (e) {
              e.preventDefault();
              var fromId = e.dataTransfer.getData("text/plain");
              if (!fromId || fromId === task.id) return;
              reorder(fromId, task.id);
            });

            listEl.appendChild(li);
          })(tasks[i]);
        }

        var total = tasks.length;
        var done = 0;
        for (var j = 0; j < tasks.length; j++) {
          if (tasks[j].completed) done++;
        }
        statsEl.textContent = "共 " + total + " 条 · 未完成 " + (total - done) + " 条";
      }

      // ========= 7. 操作 =========
      function add(text) {
        var t = text.trim();
        if (!t) return;
        tasks.unshift({
          id: Date.now().toString() + Math.random().toString(16).slice(2),
          text: t,
          completed: false
        });
        saveAll();
        render();
      }

      function toggle(id) {
        for (var i = 0; i < tasks.length; i++) {
          if (tasks[i].id === id) {
            tasks[i].completed = !tasks[i].completed;
            break;
          }
        }
        saveAll();
        render();
      }

      function reorder(fromId, toId) {
        var fromIndex = -1, toIndex = -1;
        for (var i = 0; i < tasks.length; i++) {
          if (tasks[i].id === fromId) fromIndex = i;
          if (tasks[i].id === toId)  toIndex  = i;
        }
        if (fromIndex === -1 || toIndex === -1) return;
        var moved = tasks.splice(fromIndex, 1)[0];
        tasks.splice(toIndex, 0, moved);
        saveAll();
        render();
      }

      function deleteTask(id) {
        var index = -1;
        for (var i = 0; i < tasks.length; i++) {
          if (tasks[i].id === id) {
            index = i;
            break;
          }
        }
        if (index === -1) return;
        tasks.splice(index, 1);
        saveAll();
        render();
      }

      // ========= 8. 事件 & 初始化 =========
      formEl.addEventListener("submit", function (e) {
        e.preventDefault();
        add(inputEl.value);
        inputEl.value = "";
        inputEl.focus();
      });

      (function init() {
        loadFromGitHub()
          .then(function () {
            // 成功从云端加载后，同步一份到本地备份
            saveToLocalBackup();
          })
          .catch(function (e) {
            if (e && e.message === "NO_TOKEN") {
              // 用户没填 token，直接用本地备份
              loadFromLocalBackup();
            } else {
              console.warn("从 GitHub 加载失败，使用本地备份：", e);
              loadFromLocalBackup();
            }
          })
          .finally(function () {
            render();
            if (inputEl) inputEl.focus();
          });
      })();
    })();
  </script>
</body>
</html>

